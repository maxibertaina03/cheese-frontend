{"ast":null,"code":"var _s = $RefreshSig$();\n// src/hooks/useHistorial.ts\nimport { useState, useMemo, useCallback } from 'react';\nimport { apiService } from '../services/api';\nexport const useHistorial = apiFetch => {\n  _s();\n  const [historialUnidades, setHistorialUnidades] = useState([]);\n  const [showHistorial, setShowHistorial] = useState(false);\n  const [filtroHistorial, setFiltroHistorial] = useState('todos');\n  const [busquedaHistorial, setBusquedaHistorial] = useState('');\n  const [fechaInicio, setFechaInicio] = useState('');\n  const [fechaFin, setFechaFin] = useState('');\n  const [tipoQuesoFiltro, setTipoQuesoFiltro] = useState('todos');\n\n  // En tu hook useHistorial\n  const fetchHistorial = useCallback(async () => {\n    try {\n      const response = await apiFetch(`${process.env.REACT_APP_API_URL}/api/historial`);\n      const data = await response.json();\n      setHistorialUnidades(data);\n    } catch (error) {\n      console.error('Error:', error);\n    }\n  }, [apiFetch /* otras dependencias estables */]);\n  const historialFiltrado = useMemo(() => {\n    return historialUnidades.filter(unidad => {\n      // Filtro por estado\n      if (filtroHistorial === 'activos' && !unidad.activa) return false;\n      if (filtroHistorial === 'agotados' && unidad.activa) return false;\n\n      // Filtro por tipo de queso\n      if (tipoQuesoFiltro !== 'todos' && unidad.producto.tipoQueso.nombre.toLowerCase() !== tipoQuesoFiltro) {\n        return false;\n      }\n\n      // Filtro por fechas (corregido para manejar zonas horarias correctamente)\n      if (fechaInicio || fechaFin) {\n        // Crear fechas ajustadas para comparar solo la parte de fecha (sin hora)\n        const unidadFecha = new Date(unidad.createdAt);\n        if (fechaInicio) {\n          const inicio = new Date(fechaInicio + 'T00:00:00');\n          // Comparar solo fecha, ignorando hora\n          const unidadDia = new Date(unidadFecha.getFullYear(), unidadFecha.getMonth(), unidadFecha.getDate());\n          const inicioDia = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());\n          if (unidadDia < inicioDia) return false;\n        }\n        if (fechaFin) {\n          const fin = new Date(fechaFin + 'T23:59:59');\n          const unidadDia = new Date(unidadFecha.getFullYear(), unidadFecha.getMonth(), unidadFecha.getDate());\n          const finDia = new Date(fin.getFullYear(), fin.getMonth(), fin.getDate());\n          if (unidadDia > finDia) return false;\n        }\n      }\n\n      // Filtro por búsqueda de texto\n      if (busquedaHistorial) {\n        var _unidad$observaciones;\n        const searchLower = busquedaHistorial.toLowerCase();\n        const matchNombre = unidad.producto.nombre.toLowerCase().includes(searchLower);\n        const matchPLU = unidad.producto.plu.includes(searchLower);\n        const matchID = unidad.id.toString().includes(searchLower);\n        const matchObservaciones = (_unidad$observaciones = unidad.observacionesIngreso) === null || _unidad$observaciones === void 0 ? void 0 : _unidad$observaciones.toLowerCase().includes(searchLower);\n        return matchNombre || matchPLU || matchID || matchObservaciones;\n      }\n      return true;\n    });\n  }, [historialUnidades, filtroHistorial, tipoQuesoFiltro, fechaInicio, fechaFin, busquedaHistorial]);\n  const statsHistorial = useMemo(() => ({\n    total: historialFiltrado.length,\n    activos: historialFiltrado.filter(u => u.activa).length,\n    agotados: historialFiltrado.filter(u => !u.activa).length,\n    pesoTotal: historialFiltrado.reduce((sum, u) => sum + Number(u.pesoInicial), 0),\n    pesoVendido: historialFiltrado.reduce((sum, u) => sum + (Number(u.pesoInicial) - Number(u.pesoActual)), 0),\n    productosDiferentes: new Set(historialFiltrado.map(u => u.producto.id)).size\n  }), [historialFiltrado]);\n  const openHistorial = async () => {\n    setShowHistorial(true);\n    await fetchHistorial();\n  };\n  const closeHistorial = () => {\n    setShowHistorial(false);\n  };\n  const deleteUnidadPermanente = async unidadId => {\n    try {\n      const response = await apiService.deleteUnidadPermanente(apiFetch, unidadId);\n      if (response.ok) {\n        // Actualizar lista local eliminando la unidad\n        setHistorialUnidades(prev => prev.filter(u => u.id !== unidadId));\n        return {\n          success: true\n        };\n      } else {\n        const errorData = await response.json();\n        return {\n          success: false,\n          error: errorData.error\n        };\n      }\n    } catch (error) {\n      return {\n        success: false,\n        error: 'Error de conexión'\n      };\n    }\n  };\n  return {\n    historialUnidades,\n    historialFiltrado,\n    showHistorial,\n    filtroHistorial,\n    busquedaHistorial,\n    fechaInicio,\n    fechaFin,\n    tipoQuesoFiltro,\n    statsHistorial,\n    setFiltroHistorial,\n    setBusquedaHistorial,\n    setFechaInicio,\n    setFechaFin,\n    setTipoQuesoFiltro,\n    deleteUnidadPermanente,\n    // ← NUEVO\n    openHistorial,\n    closeHistorial,\n    fetchHistorial\n  };\n};\n_s(useHistorial, \"wLuD5CxahqduedYD8afYVvLodlQ=\");","map":{"version":3,"names":["useState","useMemo","useCallback","apiService","useHistorial","apiFetch","_s","historialUnidades","setHistorialUnidades","showHistorial","setShowHistorial","filtroHistorial","setFiltroHistorial","busquedaHistorial","setBusquedaHistorial","fechaInicio","setFechaInicio","fechaFin","setFechaFin","tipoQuesoFiltro","setTipoQuesoFiltro","fetchHistorial","response","process","env","REACT_APP_API_URL","data","json","error","console","historialFiltrado","filter","unidad","activa","producto","tipoQueso","nombre","toLowerCase","unidadFecha","Date","createdAt","inicio","unidadDia","getFullYear","getMonth","getDate","inicioDia","fin","finDia","_unidad$observaciones","searchLower","matchNombre","includes","matchPLU","plu","matchID","id","toString","matchObservaciones","observacionesIngreso","statsHistorial","total","length","activos","u","agotados","pesoTotal","reduce","sum","Number","pesoInicial","pesoVendido","pesoActual","productosDiferentes","Set","map","size","openHistorial","closeHistorial","deleteUnidadPermanente","unidadId","ok","prev","success","errorData"],"sources":["C:/Users/Usuario/Desktop/cheese-stock-system/frontend/src/hooks/useHistorial.ts"],"sourcesContent":["  // src/hooks/useHistorial.ts\r\nimport { useState, useMemo, useCallback } from 'react';\r\nimport { Unidad, FiltroHistorial } from '../types';\r\nimport { apiService } from '../services/api';\r\n\r\nexport const useHistorial = (apiFetch: any) => {\r\n  const [historialUnidades, setHistorialUnidades] = useState<Unidad[]>([]);\r\n  const [showHistorial, setShowHistorial] = useState(false);\r\n  const [filtroHistorial, setFiltroHistorial] = useState<FiltroHistorial>('todos');\r\n  const [busquedaHistorial, setBusquedaHistorial] = useState('');\r\n  const [fechaInicio, setFechaInicio] = useState('');\r\n  const [fechaFin, setFechaFin] = useState('');\r\n  const [tipoQuesoFiltro, setTipoQuesoFiltro] = useState<string>('todos');\r\n\r\n// En tu hook useHistorial\r\nconst fetchHistorial = useCallback(async () => {\r\n  try {\r\n    const response = await apiFetch(`${process.env.REACT_APP_API_URL}/api/historial`);\r\n    const data = await response.json();\r\n    setHistorialUnidades(data);\r\n  } catch (error) {\r\n    console.error('Error:', error);\r\n  }\r\n}, [apiFetch, /* otras dependencias estables */]);\r\n\r\n\r\n  const historialFiltrado = useMemo(() => {\r\n    return historialUnidades.filter(unidad => {\r\n      // Filtro por estado\r\n      if (filtroHistorial === 'activos' && !unidad.activa) return false;\r\n      if (filtroHistorial === 'agotados' && unidad.activa) return false;\r\n\r\n      // Filtro por tipo de queso\r\n      if (tipoQuesoFiltro !== 'todos' && \r\n          unidad.producto.tipoQueso.nombre.toLowerCase() !== tipoQuesoFiltro) {\r\n        return false;\r\n      }\r\n\r\n      // Filtro por fechas (corregido para manejar zonas horarias correctamente)\r\n      if (fechaInicio || fechaFin) {\r\n        // Crear fechas ajustadas para comparar solo la parte de fecha (sin hora)\r\n        const unidadFecha = new Date(unidad.createdAt);\r\n        \r\n        if (fechaInicio) {\r\n          const inicio = new Date(fechaInicio + 'T00:00:00');\r\n          // Comparar solo fecha, ignorando hora\r\n          const unidadDia = new Date(unidadFecha.getFullYear(), unidadFecha.getMonth(), unidadFecha.getDate());\r\n          const inicioDia = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());\r\n          if (unidadDia < inicioDia) return false;\r\n        }\r\n        \r\n        if (fechaFin) {\r\n          const fin = new Date(fechaFin + 'T23:59:59');\r\n          const unidadDia = new Date(unidadFecha.getFullYear(), unidadFecha.getMonth(), unidadFecha.getDate());\r\n          const finDia = new Date(fin.getFullYear(), fin.getMonth(), fin.getDate());\r\n          if (unidadDia > finDia) return false;\r\n        }\r\n      }\r\n\r\n      // Filtro por búsqueda de texto\r\n      if (busquedaHistorial) {\r\n        const searchLower = busquedaHistorial.toLowerCase();\r\n        const matchNombre = unidad.producto.nombre.toLowerCase().includes(searchLower);\r\n        const matchPLU = unidad.producto.plu.includes(searchLower);\r\n        const matchID = unidad.id.toString().includes(searchLower);\r\n        const matchObservaciones = unidad.observacionesIngreso?.toLowerCase().includes(searchLower);\r\n        \r\n        return matchNombre || matchPLU || matchID || matchObservaciones;\r\n      }\r\n\r\n      return true;\r\n    });\r\n  }, [historialUnidades, filtroHistorial, tipoQuesoFiltro, fechaInicio, fechaFin, busquedaHistorial]);\r\n\r\n  const statsHistorial = useMemo(() => ({\r\n    total: historialFiltrado.length,\r\n    activos: historialFiltrado.filter(u => u.activa).length,\r\n    agotados: historialFiltrado.filter(u => !u.activa).length,\r\n    pesoTotal: historialFiltrado.reduce((sum, u) => sum + Number(u.pesoInicial), 0),\r\n    pesoVendido: historialFiltrado.reduce((sum, u) => \r\n      sum + (Number(u.pesoInicial) - Number(u.pesoActual)), 0),\r\n    productosDiferentes: new Set(historialFiltrado.map(u => u.producto.id)).size,\r\n  }), [historialFiltrado]);\r\n\r\n  const openHistorial = async () => {\r\n    setShowHistorial(true);\r\n    await fetchHistorial();\r\n  };\r\n\r\n  const closeHistorial = () => {\r\n    setShowHistorial(false);\r\n  };\r\n\r\n\r\n  const deleteUnidadPermanente = async (unidadId: number) => {\r\n  try {\r\n    const response = await apiService.deleteUnidadPermanente(apiFetch, unidadId);\r\n    if (response.ok) {\r\n      // Actualizar lista local eliminando la unidad\r\n      setHistorialUnidades(prev => prev.filter(u => u.id !== unidadId));\r\n      return { success: true };\r\n    } else {\r\n      const errorData = await response.json();\r\n      return { success: false, error: errorData.error };\r\n    }\r\n  } catch (error) {\r\n    return { success: false, error: 'Error de conexión' };\r\n  }\r\n  };\r\n\r\n  return {\r\n    historialUnidades,\r\n    historialFiltrado,\r\n    showHistorial,\r\n    filtroHistorial,\r\n    busquedaHistorial,\r\n    fechaInicio,\r\n    fechaFin,\r\n    tipoQuesoFiltro,\r\n    statsHistorial,\r\n    setFiltroHistorial,\r\n    setBusquedaHistorial,\r\n    setFechaInicio,\r\n    setFechaFin,\r\n    setTipoQuesoFiltro,\r\n    deleteUnidadPermanente,  // ← NUEVO\r\n    openHistorial,\r\n    closeHistorial,\r\n    fetchHistorial,\r\n    \r\n  };\r\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}